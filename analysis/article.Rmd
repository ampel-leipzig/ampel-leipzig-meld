---
# R markdown template taken from
# Dan Holmes <dtholmes@mail.ubc.ca>
# https://labrtorian.com/2019/08/26/rmarkdown-template-that-manages-academic-affiliations/
title: "A Model to Predict Survival in Patients with End-Stage Liver Disease"
subtitle: >
    Comparision against MELD, MELD-Na, MELD-Plus7.
abstract: >
  **Background**:
      TODO

  **Methods**:
      TODO

  **Results**:
      TODO

  **Conclusion**:
      TODO

author:
    - Sebastian Gibb:
        email: mail@sebastiangibb.de
        institute: [ILM, KAINS]
        correspondence: true
    - Thorsten Kaiser:
        email: thorsten.kaiser@medizin.uni-leipzig.de
        institute: ILM
        correspondence: false
institute:
    - ILM: Institute of Laboratory Medicine, Clinical Chemistry and Molecular Diagnostics, University Hospital Leipzig, Paul-List-Str. 13-15, D-04103 Leipzig, Germany.
    - KAINS: Anesthesiology and Intensive Care Medicine, University Hospital Greifswald, Ferdinand-Sauerbruch-Stra√üe, D-17475 Greifswald, Germany.
date: "`r Sys.Date()`"
bibliography:
  - "`r rprojroot::find_rstudio_root_file('analysis', 'bibliography', 'bibliography.bib')`"
  - "`r rprojroot::find_rstudio_root_file('analysis', 'bibliography', 'rpackages', 'article.bib')`"
output:
  bookdown::html_document2:
    pandoc_args: # pandoc_args doesn't support r evaluation
      - --lua-filter=pandoc/lua-filters/scholarly-metadata.lua
      - --lua-filter=pandoc/lua-filters/author-info-blocks.lua
---

```{r knitr_setup, include=FALSE}
knitr::write_bib(
    c(
        "base",
        "targets", "workflowr",
        "mlr3", "mlr3proba", "zlog",
        "survival", "glmnet", "penalized", "ranger", "randomForestSRC",
        "xgboost", "survivalsvm", "survivalmodels"
    ),
    file = rprojroot::find_rstudio_root_file(
        "analysis", "bibliography", "rpackages", "article.bib"
    )
)
```

```{r article_setup, include=FALSE}
library("targets")
library("ggplot2")
library("mlr3viz")
library("viridis")
library("ameld")

tar_load(bmrk_results)
tar_load(crossval)

tar_load(raw_data)
tar_load(labelled_meld_data)

tar_load(tbl1)
tar_load(tbl_observed_vs_expected_mortality)
```

# Introduction

Liver cirrhosis is the terminal result of fibrotic remodeling
of liver tissue due to chronic damage. An organ failure is often
irreversible and the only available therapy is liver transplantation.
However, the shortage in grafts for transplantation from deceased donors
requires risk stratification and precise allocation rules.
The allocation of liver transplantation in most countries is based on
disease severity determined by the model of end-stage liver disease (MELD)
[@malinchoc2000; @wiesner2003; @optn_policies2021].
The MELD score estimates the patients' 3-month mortality risk based on
laboratory results, namely bilirubin, creatinine and international normalized
ratio (INR). In general the MELD score is extended by the sodium level
(MELD-Na score) as this was found to be an important additional risk factor in
liver cirrhosis [@kim2008; @optn_policies2021].
The MELD was initially developed for predicting the survival of patients
undergoing transjugular intrahepatic portosystemic shunts.
Afterwards it was revalidated for predicting mortality risk in patients awaiting
a liver transplantation.
Although the MELD score should be an objective allocation score especially the
creatinine and INR are highly dependent on the utilized laboratory methods
[@trotter2004; @cholongitas2007]. Patients with identical disease state could
have very different MELD scores and thus get different priority on the liver
transplantation waiting list.
Furthermore often, e.g. for acute-on-chronic liver failure, the MELD score
underestimates the mortality risk [@hernaez2020].

There have been some attempts to use the data extracted from more than 300.000
electronic medical records from two hospitals in the United States to improve
the MELD score [@kartoun2017]. The derived MELD-Plus7 and MELD-Plus9 risk score
add albumin, white blood cell count, age and total cholesterol and length of
stay to the MELD-Na variables. Despite its published prediction improvement the
MELD-Plus scores are not used for transplant allocation yet.

As depicted by MELD-Plus risk scores better predictive scores often need more
variables and are more complicated. To reduce the risk of overlooking or
incorrectly calculating and interpreting the results,
clinical decision support systems may be used and could improve patient safety.
The research project on digital laboratory medicine (AMPEL) develops a
clinical decision support system based on laboratory diagnostics that should
support clinical practitioners in interpreting the laboratory results and taking
the necessary medical interventions [@eckelt2020].

This study aims to find clinical and laboratory values that improve the risk
stratification for liver transplantation over classical MELD, MELD-Na and
MELD-Plus scores and could be implemented as part of the AMPEL clinical decision
support system.

# Material and methods

## Study population

```{r excluded, include = FALSE}
n_excluded <- attr(raw_data, "excluded")
n_analysed <- nrow(raw_data)
n_total <- sum(n_analysed, n_excluded)

cn_labs <- grep("_[CESQ]$", colnames(raw_data), value = TRUE)
```

In a retrospective cohort study we followed `r n_total` consecutive
patients, who were recruited during the evaluation process for
liver transplantation at the University Hospital of Leipzig from
`r paste(format(attr(raw_data, "period"), "%B %Y"), collapse = " to ")`.
For each patient we recorded `r ncol(raw_data)` variables.
Among them are age, sex, etiology of liver disease, complications as listed in
Table \@ref(tab:tbl1) and `r length(cn_labs)` laboratory measurements.

```{r flowchart, results = "asis", echo = FALSE, fig.width = 5, fig.height = 5, fig.cap = "Flowchart Inclusion/Exclusion."}
graph <- "
digraph flowchart {
    graph [splines = false];

    // invisible nodes
    node [shape = point, width = 0, height = 0];
    iAR [style = 'invis'];

    // visible nodes
    node [shape = box];
    A [label = '@@1'];
    E [label = '@@3'];
    R [label = '@@2'];

    // edge statements
    A -> iAR [arrowhead = none];
    {rank = same; iAR -> E [minlen = 5]};
    iAR -> R;
}

[1]: paste0('Total Records\\n(n = ', n_total, ')')
[2]: paste0('Analysed Records\\n(n = ', n_analysed, ')')
[3]: str_excluded
"
str_excluded <- paste0(
    'Excluded (n = ', sum(n_excluded), ')\\\\l',
    paste0(
        '- ',
        paste(
            c(
                'Younger than 18 years:',
                'Liver Transplantation before visit:',
                'Follow-up missing/invalid:'
            ),
            n_excluded
        ),
        collapse = '\\\\l'
    ),
    '\\\\l'
)

DiagrammeR::grViz(graph)
```

We excluded `r sum(n_excluded)` patients from our analysis
(Figure \@ref(fig:flowchart)).
`r if (n_excluded["Children"] == 1) "One was" else paste(n_excluded["Children"], "were")` younger than 18 years.
`r n_excluded["LiverTransplantation"]` had a liver transplantation before and
in `r n_excluded["LostFollowUp"]` cases the follow up data were missing or
invalid.

The Ethics Committee at the Leipzig University Faculty of
Medicine approved the retrospective usage of the data for our study
(reference number: 039/14ff).

## MELD scores

MELD and MELD-Na were calculated as described in
@optn_policies2021 using the following formulas:
$MELD = 10 * (0.957 \ln(creatinine [mg/dl]) + 0.378 \ln(bilirubin [mg/dl]) + 1.120 * \ln(INR) + 0.643)$,
Creatinine, bilirubin and INR values lower than 1.0 mg/dl were set to 1.0 mg/dl.
The maximum allowed creatinine was 4.0 mg/dl. If patients received dialysis,
creatinine was set to 4.0 mg/dl.
For MELD-Na MELD was calculated as above and recalculated if greater than 11 using:
$MELD\text{-}Na = MELD_i + 1.32 * (137 - Na [mmol/l]) - (0.033 * MELD_i * (137 - Na [mmol/l]))$

Serum sodium values lower than 125 mmol/l or higher than 137 mmol/l were set
to 125 mmol/l and 137 mmol/l, respectively.

The MELD-Plus7 risk score was calculated as described in @kartoun2017:
$$
\begin{aligned}
L = 8.53499496 &+ \\
    2.59679650 &* \log_{10}(1 + creatinine [mg/dl]) + \\
    2.06503238 &* \log_{10}(1 + bilirubin [mg/dl]) + \\
    2.99724802 &* \log_{10}(1 + INR) - \\
    6.47834101 &* \log_{10}(1 + sodium [mmol/l]) - \\
    6.34990436 &* \log_{10}(1 + albumin [g/l]) + \\
    1.92811726 &* \log_{10}(1 + wbc [th/cumm]) + \\
    0.04070442 &* age [years]
\end{aligned}
$$

$$MELD\text{-}Plus = \frac{\exp(L)}{1 + \exp(L)}$$

The MELD-Plus9 score was ignored because the length of stay information was not
available for our cohort and the model itself wasn't superior to MELD-Plus7 in
its original publication [@kartoun2017].

## Data processing and machine learning

```{r ml, include = FALSE}
n_lrns <- sum(!grepl("^scale..*", bmrk_results$learners$learner_id))
#n_cv <- c(inner.folds
#    outer = unlist(
#        bmrk_results$resamplings$resampling[[1]]$param_set$get_values()
#    )
#)
```

All data processing, statistical and machine learning analyses were performed
using R version
`r paste0(sessionInfo()$R.version[c("major", "minor")], collapse = ".")`
[@R-base].
Prior to the analyses all laboratory values were *zlog* transformed
as described in @hoffmann2017 and implemented in @R-zlog.

$$
z = (\log(x) - \frac{\log(LL) + \log(UL)}{2}) * \frac{3.92}{\log(UL) - \log(LL)}
$$

Where $LL$ and $UL$ are the lower and upper reference limit of
the corresponding laboratory diagnostic, respectively.
Missing laboratory measurements were replaced with a *zlog* value of zero.
In similar manner if information about complications or
comorbidities were missing we treat them as not present.

We compared `r n_lrns` different statistical and machine learning
algorithms using the mlr3 framework
[@mlr3; @R-mlr3; @mlr3proba2021; @R-mlr3proba].
The used algorithms are designed for analysis of survival data:
Cox proportional hazards regression model
[@cox1972; @survival-book; @R-survival],
penalized regressions,
namely two different implementations of the
lasso (least absolute shrinkage and selection operator) regression
[@tibshirani1997; @glmnet2011; @R-glmnet; @penalized2010; @R-penalized],
tow different implementations of the
ridge regression [@glmnet2011; @R-glmnet; @penalized2010; @R-penalized], and
the elastic net regression [@glmnet2011; @R-glmnet],
two different random forest implementations
[@ranger2017; @R-ranger; @randomForestSRC2008; @R-randomForestSRC],
extreme gradient boosting [@chen2016; @R-xgboost],
two different support vector machines [@vanbelle2011; @R-survivalsvm]
and a neural network [@katzman2018; @R-survivalmodels].

To choose the best model we used nested resampling to avoid feature- and
model-selection-bias.
Therefore, we applied a `r crossval$inner$param_set$values$folds`-fold inner
and a `r crossval$outer$param_set$values$folds`-fold outer cross-validation
that was repeated `r crossval$outer$param_set$values$repeats` times.
Subsequently we selected the model with the
highest median concordance index [@harrell1982]. If multiple models were
comparable we chose the simpler (more penalized) one.

TODO: selected final model, analysis, feature selection

# Results

## Baseline characteristics

```{r tbl1, results = "asis", echo = FALSE, message = FALSE}
library("gtsummary")
theme_gtsummary_journal(journal = "jama")
theme_gtsummary_compact()
tbl1
```

<!-- TODO:
use `pattern` argument to provide "{n} ({p}%)" for categorial/dichotomos
variables after this PR is merged
https://github.com/ddsjoberg/gtsummary/pull/951
-->

```{r tbl1_helper_func, echo = FALSE}
.tbl1 <- function(variable, column = "Overall", ...) {
    id <- gtsummary::inline_text(
        tbl1, variable = all_of(variable), column = "tbl_id1"
    )
    if (column == "Overall")
        column <- "stat_0"
    gtsummary::inline_text(
        tbl1$tbls[[id]],
        variable = all_of(variable), column = all_of(column), ...
    )
}
```

In this study we analysed a cohort of `r n_analysed` patients evaluated for
liver transplantation (Tab. \@ref(tab:tbl1)).
`r sprintf("%i (%s)", sum(raw_data$Sex == "male"), gtsummary::style_percent(mean(raw_data$Sex == "male"), symbol = TRUE))`
of them were men.
The median (IQR) follow-up times was `r .tbl1("DaysAtRisk")` days.
Within the follow-up time `r .tbl1("LTx")` patients received a liver transplant
and were censored for the analysis beyond this time point.
The median (IQR) age of the cohort was `r .tbl1("Age")` years.

Most of the patients presented with cirrhosis
(`r .tbl1("Cirrhosis")`).
The remaining patients had an acute liver failure
(`r .tbl1("ALF")`) or
a chronic liver insufficiency
(`r .tbl1("CLI")`).
At evaluation time the median (IQR) MELD and MELD-Na score were
`r .tbl1("ScoreMeldUnos")` and
`r .tbl1("ScoreMeldNaUnos")`, respectively.
Within 90 days `r .tbl1("M90")` patients died.
In nearly two third of all patients alcohol was the main cause
(`r .tbl1("Ethyltoxic")`) of their end-stage liver disease.
The remaining patients had viral infections
(hepatitis B and C viruse `r .tbl1("HBV")` and `r .tbl1("HCV")`, respectively),
autoimmune processes (autoimmune hepatitis `r .tbl1("AIH")`,
primary sclerosing cirrhosis `r .tbl1("PSC")`),
primary biliary cirrhosis `r .tbl1("PBC")` or unknown causes
(non-alcoholic steatohepatitis `r .tbl1("NASH")` and
cryptogenic hepatitis `r .tbl1("Cryptogenic")`).
The most common complications among all patients were gastrointestinal
bleedings in `r .tbl1("GIB")` patients, followed by
hepatocellular carcinoma (HCC) in `r .tbl1("HCC")` and
spontaneous bacterial peritonitis (SBP) in `r .tbl1("SBP")` patients.
Just `r .tbl1("Dialysis")` patients required a renal dialysis.

## MELD scores

According to @wiesner2003 we divided our cohort into
`r nlevels(labelled_meld_data$MeldCategory)` MELD-score risk
categories, with `r enum(table(labelled_meld_data$MeldCategory))` patients,
respectively.
As shown in Table \@ref(tab:tbl-observed-vs-expected-mortality)
our observed 90 day mortality was
`r paste(round(range(tbl_observed_vs_expected_mortality$StandardizedMortalityRatio[-1]), 1), collapse = " to ")`
times higher than the predicted one. Just in the group with the lowest MELD
scores the mortality was much lower.

```{r tbl-observed-vs-expected-mortality, results = "asis", echo = FALSE, message = FALSE}
tbl_observed_vs_expected_mortality$ObservedMortality <-
    tbl_observed_vs_expected_mortality$ObservedMortality * 100
tbl_observed_vs_expected_mortality$ExpectedMortality <-
    tbl_observed_vs_expected_mortality$ExpectedMortality * 100
knitr::kable(
    cbind(
        row.names(tbl_observed_vs_expected_mortality),
        tbl_observed_vs_expected_mortality
    ),
    row.names = FALSE,
    col.names =
        c(
            "MELD category",
            "Observed deaths (n)",
            "Expected deaths (n)",
            "Standardized mortality ratio (SMR)",
            "Observed mortality (%)",
            "Expected mortality (%)"
        ),
    caption = paste0(
        "Observed vs MELD-expected 90 day mortality. ",
        "MELD mortality values are taken from @wiesner2003. ",
        "All patients censored before day 90 are ignored for ",
        " the calculation of the MELD-expected deaths. ",
        "SMR, Standardized mortality ratio = observed deaths/expected deaths."
    ),
    digits = 1
)
```

```{r benchmark-plot, fig.cap = "Benchmark results of machine learning algorithms."}
r <- bmrk_results$clone()
id <- grep("^scale", x = r$learners$learner_id, invert = TRUE, value = TRUE)
r$filter(task_id = "zlog_eldd", learner_id = id)
autoplot(r) +
    geom_boxplot(aes(fill = learner_id)) +
    geom_jitter(position = position_jitter(0.2)) +
    scale_fill_viridis(discrete = TRUE) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

TODO: mention best ml algorithm (\@ref(fig:benchmark-plot))

# Discussion

In this retrospective analysis of `r n_analysed` consecutive patients,
who were recruited during the evaluation process for liver transplantation at
the University Hospital of Leipzig we compared
`r n_lrns` different statistical and machine learning algorithms.

...

- higher mortality than predicted, compare @hernaez2020
- adding sodium doesn't add much/any discrimination information
    - as already seen in @kartoun2017
- @kartoun2017 uses > 60 variables mostly clinical stuff, just few laboratory values, none of the clinical stuff remains
- general low sample size thus simpler models/fewer predictors are preferred.
- comparison of different predictors of MELD-Plus7 (+MELD-Plus9) vs our features
    - 90 day mortality *post* discharge
    - poorer performance in own validation set (lower and more uniform disease severity, also lower MELD)
- machine learning algorithms worse than statistical learning (lower c-index, higher variance/instability)
    - additive effects (favour statistical models)
    - low sample size, for ML more than 200 events per predictor variable necessary [@ploeg2014]
- national register required

## Limitations

- comparable mortality?
- retrospective analysis
- single center
- unknown cause of death (death with vs of end-stage liver disease)
- bias caused by LTx censorship?

# References
