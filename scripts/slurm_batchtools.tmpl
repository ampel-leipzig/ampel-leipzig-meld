#!/bin/bash
<%
# relative paths are not handled well by Slurm
logfile = fs::path_expand(resources$logfile)
if (!"walltime" %in% names(resources)) {
  resources$walltime = 48 * 3600
}
-%>

#SBATCH --job-name=<%= job.name %>
#SBATCH --output=<%= logfile %>
#SBATCH --error=<%= logfile %>
<%= if (!is.null(resources$partition)) sprintf("#SBATCH --partition='%s'", resources$partition) %>
#SBATCH --ntasks=1
<%= if (!is.null(resources$ncpu)) sprintf("#SBATCH --cpus-per-task=%d", resources$ncpu) %>
<%= if (!is.null(resources$mcpu)) sprintf("#SBATCH --mem-per-cpu=%d", resources$mcpu) %>
#SBATCH --mail-type=ALL
#SBATCH --mail-user=gibbs@uni-greifswald.de
#SBATCH --time=<%= ceiling(resources$walltime / 60) %>

SINGULARITYVER=3.4.2
SINGULARITYPATH=/opt/singularity-${SINGULARITYVER}/bin/singularity

. /usr/share/Modules/init/bash
module load singularity/${SINGULARITYVER} slurm

export DEBUGME=<%= Sys.getenv("DEBUGME") %>

BIND_PATH="/etc/group,/etc/passwd,/etc/slurm,/var/run"

SINGULARITYENV_LOCPATH=/lib/locale/2.31/ \
    SINGULARITYENV_TAR_MAKE_REPORTER="timestamp" \
    SINGULARITYENV_TZ="UTC" \
    SINGULARITY_BIND="${BIND_PATH}" \
    ${SINGULARITYPATH} run container/ampel-leipzig-meld.squashfs \
    -e 'batchtools::doJobCollection("<%= uri %>")'
exit 0
